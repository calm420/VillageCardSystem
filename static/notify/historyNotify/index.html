<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <title>历史通知</title>
    <link rel="stylesheet" href="../../css/index.css">
    <link rel="stylesheet" href="../../css/noticeReadMore.css">
    <link rel="stylesheet" href="../../css/skin/skin_middleSchool.css">
    <link rel="stylesheet" href="../../css/skin/skin_primarySchool.css">
    <link rel="stylesheet" href="../../css/skin/skin_default.css">
    <script src="https://www.maaee.com/Excoord_PhoneService/js/jsbridge.js?v=18"></script>
    <script type="text/javascript" src="../../js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="../../js/webServiceUtil.js"></script>
    <script type="text/javascript" src="./js/pullLoad.js"></script>
    <script type="text/javascript" src="../../js/simple_websocket_connection.js"></script>
</head>

<body>
    <div id="skin_default" name="historyNotify" style="height: 100%">
        <div id="noticeReadMore" class="home_content">
            <div class="inner_bg">
                <div class="navBar">
                    <span id="historyGoBack">首页</span>
                    <span class="icon"></span>
                    <span>通知</span>
                </div>
                <!--分页-->
                <div class="swiper">
                    <div class="swiper-container">
                        <div class="swiper-wrapper">
                            <!--填充数据 -->
                        </div>
                        <div class="preloader"> 上拉加载数据 </div>
                    </div>
                </div>

            </div>
            <div onClick="closePlayerMask()" id='videoPlayerMask' style="display: none">
                <div class="close_box" onClick="closePlayerMask()"><span class="close">关闭</span></div>
                <img id="imagePlayerAr" src="" alt="">
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">

    var loadFilter = true;
    //页码
    var slideNumber = 1;
    var skin = WebServiceUtil.GetQueryString("skin");
    var font = WebServiceUtil.GetQueryString('font');
    $('html').css('font-size', font);
    var roomId;
    document.getElementsByName("historyNotify")[0].id = skin;
    var simpleMs = new SimpleConnection();
    simpleMs.connect();
    //给定swiper固定高度
    $(".swiper").height($('.inner_bg').height() - $('.navBar').height());
    $(".swiper-container").height($('.inner_bg').height() - $('.navBar').height())
    InitializePage();

    $('.swiper-container').on('scroll', function (e) {
        var container = document.getElementsByClassName('swiper-container')[0];
        var scorllTop = container.scrollTop;
        var maxScroll = container.scrollHeight - container.offsetHeight;
        if (scorllTop >= maxScroll) {
            if (loadFilter) {
                loadFilter = false;
                $('.preloader').text('正在加载...');
                setTimeout(function () {
                    getNotifyInfo(roomId);
                }, 500)
            }

        }

    })

    function simpleListener() {
        simpleMs.msgWsListener = {
            onError: function (errorMsg) {
                // Toast.fail(errorMsg)
            }, onWarn: function (warnMsg) {
                // Toast.fail(warnMsg)
            }, onMessage: function (info) {
                console.log("info", info);
                if (info.command == "refreshClassCardPage") {
                    goHome();
                }
            }
        }
    }

    /**
   * li元素的点击事件
   */
    onClick = function (index) {
        if ($('li').eq(index).find(".noticeContent").css("display") == "none") {
            $("li").find(".noticeContent").css({
                display: 'none'
            })
            $('li').eq(index).find(".noticeContent").css({
                display: 'block'
            })

        } else {
            $('li').eq(index).find(".noticeContent").css({
                display: 'none'
            })
            $("li").eq(index + 1).find(".noticeContent").css({
                display: 'block'
            })
        }
    }

    /**
    * getTimeFormat时间戳转换格式
    */
    getTimeFormat = function (t) {
        var _time = new Date(t);
        // var   year=_time.getFullYear();//年
        var month = (_time.getMonth() + 1) < 10 ? ("0" + (_time.getMonth() + 1)) : (_time.getMonth() + 1);//月
        var date = _time.getDate() < 10 ? "0" + _time.getDate() : _time.getDate();//日
        var hour = _time.getHours() < 10 ? "0" + _time.getHours() : _time.getHours();//时
        var minute = _time.getMinutes() < 10 ? "0" + _time.getMinutes() : _time.getMinutes();//分
        // var   second=_time.getSeconds();//秒
        return month + "/" + date + " " + hour + ":" + minute;
    }

    //初始化页面元素
    function InitializePage() {
        roomId = WebServiceUtil.GetQueryString("roomId");
        getNotifyInfo(roomId);
        simpleListener();
    }
    function getNotifyInfo(roomId) {
        var param = {
            "method": 'getClassBrandNoticeListByClassId',
            "classroomId": roomId,
            "pageNo": slideNumber
        };
        WebServiceUtil.requestLittleAntApi(true, JSON.stringify(param), {
            onResponse: function (result) {
                var newArr = [];
                result.response.forEach(function (v, i) {
                    v.createTime = getTimeFormat(v.createTime);
                    newArr.push(v);
                })
                var rowData = newArr;
                var wrapper = $('.swiper-wrapper');
                // 数据为空
                if (rowData.length == 0 && slideNumber == 1) {
                    wrapper.append("<div class='emptyPage_content'><div class='empty_center'><div class='emptyPage_icon emptyPage_publicImg'></div><div class='emptyPage_text'>暂无数据</div></div></div>");
                }
                if (result.msg == '调用成功' || result.success == true) {
                    if (rowData.length == 0 && slideNumber != 1) {
                        $('.preloader').text('无更多数据');
                        // wrapper.append("<div class='noMoreData'>无更多数据</div>", 'swiper-slide');
                        loadFilter = false;
                    } else {
                        rowData.forEach(function (v, i) {
                            if (i == 0) {
                                wrapper.append(
                                    '<li  >' +
                                    '<p onClick = "onClick(' + i + ')" class="title"><span class="titleCont">' + v.noticeTitle + '</span><span class="time">' + v.createTime + '</span>' +
                                    '</p>' +
                                    '<div class="noticeContent" style="display:block"><pre>' + v.noticeContent + '</pre></div>' +
                                    '</li >'
                                )
                            } else {
                                wrapper.append(
                                    '<li  >' +
                                    '<p onClick = "onClick(' + i + ')" class="title"><span class="titleCont">' + v.noticeTitle + '<span></span><span class="time">' + v.createTime + '</span>' +
                                    '</p>' +
                                    '<div class="noticeContent" style="display:none"><pre>' + v.noticeContent + '</pre></div>' +
                                    '</li >'
                                )
                            }

                        })
                        slideNumber++;
                        loadFilter = true;
                    }

                }
            },
            onError: function (error) {
                // message.error(error);
                $('body').html("查询出错:" + JSON.stringify(responseStr))
            }
        });
    }

    $('#historyGoBack').on('click', function () {
        goHome();
    })

    function goHome() {
        console.log('返回首页');
        var data = {
            method: 'finish',
        };
        Bridge.callHandler(data, null, function (error) {
            window.history.back(-1);
        });
    }


    $(document).on('click', '.editor_image', function (e) {
        console.log(e.currentTarget.currentSrc)
        var imgSrc = e.currentTarget.currentSrc.split("?");
        playImage(imgSrc[0])
    })

    function playImage(src) {
        document.getElementById('videoPlayerMask').style.display = 'block';
        document.getElementById('imagePlayerAr').src = src;
    }

    function closePlayerMask() {
        document.getElementById('imagePlayerAr').src = "";
        document.getElementById('videoPlayerMask').style.display = 'none';
    }

</script>

</html>