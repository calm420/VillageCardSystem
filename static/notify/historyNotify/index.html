<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>历史通知</title>
    <link rel="stylesheet" href="../../css/index.css">
    <link rel="stylesheet" href="../../css/noticeReadMore.css">
    <link rel="stylesheet" href="../../css/skin/skin_middleSchool.css">
    <link rel="stylesheet" href="../../css/skin/skin_primarySchool.css">
    <link rel="stylesheet" href="../../css/skin/skin_default.css">
    <script src="https://www.maaee.com/Excoord_PhoneService/js/jsbridge.js?v=18"></script>
    <script type="text/javascript" src="../../js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="../../js/webServiceUtil.js"></script>

</head>

<body>
    <div id="skin_default" name="historyNotify" style="height: 100%">
        <div id="noticeReadMore" class="home_content">
            <div class="inner_bg">
                <div class="navBar">
                    <span id="historyGoBack">首页</span>
                    <span class="icon"></span>
                    <span>通知</span>
                </div>
                <!--分页-->
                <div class="swiper">
                    <div class="swiper-container">
                        <div class="swiper-wrapper">
                            <!--填充数据 -->
                        </div>
                        <div class="preloader"> 上拉加载数据 </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</body>
<script type="text/javascript">

    //拖动偏移量
    var holdPosition = 0;
    //截流阀
    var loadFilter = true;
    // var holdPosition =
    //页码
    var slideNumber = 1;
    var skin = getQueryString("skin");
    var roomId;
    document.getElementsByName("historyNotify")[0].id = skin;
    //给定swiper固定高度
    $(".swiper").height($('.inner_bg').height() - $('.navBar').height());
    $(".swiper-container").height($('.inner_bg').height() - $('.navBar').height())
    InitializePage();

    $('.swiper-container').on('scroll', function (e) {
        var container = document.getElementsByClassName('swiper-container')[0];
        // console.log(container);
        var scorllTop = container.scrollTop;
        var maxScroll = container.scrollHeight - container.offsetHeight;
        // console.log(scorllTop,'scrollTop');
        // console.log(maxScroll,'maxScroll');
        if (scorllTop >= maxScroll) {
            // console.log('开始上拉');
            // $('.swiper-container').css({transform: 'translate(0,-100px)'});
            if (loadFilter) {
                loadFilter = false;
                $('.preloader').text('正在加载...');
                setTimeout(function () {
                    getNotifyInfo(roomId);
                }, 500)
            }

        }

    })




    /**
   * li元素的点击事件
   */
    onClick = function (index) {
        if ($('li').eq(index).find(".noticeContent").css("display") == "none") {
            $("li").find(".noticeContent").css({
                display: 'none'
            })
            $('li').eq(index).find(".noticeContent").css({
                display: 'block'
            })

        } else {
            $('li').eq(index).find(".noticeContent").css({
                display: 'none'
            })
            $("li").eq(index + 1).find(".noticeContent").css({
                display: 'block'
            })
        }


    }

    /**
    * getTimeFormat时间戳转换格式
    */
    getTimeFormat = function (t) {
        var _time = new Date(t);
        // var   year=_time.getFullYear();//年
        var month = (_time.getMonth() + 1) < 10 ? ("0" + (_time.getMonth() + 1)) : (_time.getMonth() + 1);//月
        var date = _time.getDate() < 10 ? "0" + _time.getDate() : _time.getDate();//日
        var hour = _time.getHours() < 10 ? "0" + _time.getHours() : _time.getHours();//时
        var minute = _time.getMinutes() < 10 ? "0" + _time.getMinutes() : _time.getMinutes();//分
        // var   second=_time.getSeconds();//秒
        return month + "/" + date + " " + hour + ":" + minute;
    }


    //初始化页面元素
    function InitializePage() {
        roomId = getQueryString("roomId");
        getNotifyInfo(roomId);
    }
    function getNotifyInfo(roomId) {
        var param = {
            "method": 'getClassBrandNoticeListByClassId',
            "classroomId": roomId,
            "pageNo": slideNumber
        };
        WebServiceUtil.requestLittleAntApi(true, JSON.stringify(param), {
            onResponse: function (result) {
                var newArr = [];
                result.response.forEach(function (v, i) {
                    v.createTime = getTimeFormat(v.createTime);
                    newArr.push(v);
                })
                var rowData = newArr;
                var wrapper = $('.swiper-wrapper');
                // 数据为空
                if (rowData.length == 0 && slideNumber == 1) {
                    wrapper.append("<div class='emptyPage_content'><div class='empty_center'><div class='emptyPage_icon emptyPage_publicImg'></div><div class='emptyPage_text'>暂无数据</div></div></div>");
                }
                if (result.msg == '调用成功' || result.success == true) {
                    if (rowData.length == 0 && slideNumber != 1) {
                        $('.preloader').text('无更多数据');
                        // wrapper.append("<div class='noMoreData'>无更多数据</div>", 'swiper-slide');
                        loadFilter = false;
                    } else {
                        rowData.forEach(function (v, i) {
                            if (i == 0) {
                                wrapper.append(
                                    '<li onClick = "onClick(' + i + ')" >' +
                                    '<p class="title">' + v.noticeTitle + '<span class="time">' + v.createTime + '</span>' +
                                    '</p>' +
                                    '<div class="noticeContent" style="display:block"><pre>' + v.noticeContent + '</pre></div>' +
                                    '</li >'
                                )
                            } else {
                                wrapper.append(
                                    '<li onClick = "onClick(' + i + ')" >' +
                                    '<p class="title">' + v.noticeTitle + '<span class="time">' + v.createTime + '</span>' +
                                    '</p>' +
                                    '<div class="noticeContent" style="display:none"><pre>' + v.noticeContent + '</pre></div>' +
                                    '</li >'
                                )
                            }

                        })
                        slideNumber++;
                        loadFilter = true;
                    }

                }
            },
            onError: function (error) {
                // message.error(error);
                $('body').html("查询出错:" + JSON.stringify(responseStr))
            }
        });
    }

    /**
   * 获取地址栏参数
   * @param name
   * @returns {null}
   * @constructor
   */
    function getQueryString(parameterName) {
        var reg = new RegExp("(^|&)" + parameterName + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
    }

    $('#historyGoBack').on('click', function () {
        console.log('返回首页');
        var data = {
            method: 'finish',
        };
        Bridge.callHandler(data, null, function (error) {
            window.history.back(-1);
        });

    })
</script>
</html>